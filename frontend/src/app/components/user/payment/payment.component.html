<div class="card">
  <div class="card-header bg-primary text-white">
    <h4>Realizar Pago</h4>
  </div>
  <div class="card-body">
    <div *ngIf="isSuccess" class="alert alert-success">
      ¡El pago se ha procesado con éxito!
      <br>Serás redirigido a tu perfil en unos segundos...
    </div>

    <ng-container *ngIf="!isSuccess">
      <!-- Información del circuito si existe -->
      <div *ngIf="pendingCircuit" class="alert alert-info mb-4">
        <h5>Pago para circuito</h5>
        <p><strong>ID del circuito:</strong> {{ pendingCircuit.id }}</p>
        <p><strong>Número de qubits:</strong> {{ pendingCircuit.qubits }}</p>
        <p><strong>Coste:</strong> {{ pendingCircuit.cost }} €</p>
      </div>

      <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="monto" class="form-label">Monto (€)</label>
          <input type="number" class="form-control" id="monto" formControlName="monto" min="1">
          <div *ngIf="isSubmitted && f['monto'].errors" class="text-danger">
            <div *ngIf="f['monto'].errors['required']">El monto es obligatorio</div>
            <div *ngIf="f['monto'].errors['min']">El monto debe ser al menos 1€</div>
          </div>
        </div>

        <div class="mb-3">
          <label for="metodoPago" class="form-label">Método de Pago</label>
          <select class="form-select" id="metodoPago" formControlName="metodoPago">
            <option *ngFor="let method of paymentMethods" [value]="method.id">{{ method.name }}</option>
          </select>
          <div *ngIf="isSubmitted && f['metodoPago'].errors" class="text-danger">
            <div *ngIf="f['metodoPago'].errors['required']">El método de pago es obligatorio</div>
          </div>
        </div>

        <!-- Campos específicos para tarjeta de crédito -->
        <div *ngIf="f['metodoPago'].value === 'tarjeta'">
          <div class="mb-3">
            <label for="cardholderName" class="form-label">Nombre del Titular</label>
            <input type="text" id="cardholderName" class="form-control" formControlName="cardholderName">
            <div *ngIf="isSubmitted && f['cardholderName'].errors" class="text-danger">
              <div *ngIf="f['cardholderName'].errors['required']">El nombre del titular es obligatorio.</div>
            </div>
          </div>

          <label class="form-label">Datos de la Tarjeta</label>
          <div id="card-element" class="form-control"></div>
          <div class="text-danger mt-2" *ngIf="cardErrors">{{ cardErrors }}</div>
        </div>


        <!-- Información para PayPal -->
        <div *ngIf="f['metodoPago'].value === 'paypal'" class="alert alert-info mb-3">
          <p>Serás redirigido a PayPal para completar el pago después de enviar este formulario.</p>
        </div>

        <!-- Información para Transferencia -->
        <div *ngIf="f['metodoPago'].value === 'transferencia'" class="alert alert-info mb-3">
          <p>Realiza una transferencia con la siguiente información:</p>
          <ul>
            <li><strong>Banco:</strong> Banco Quantum</li>
            <li><strong>IBAN:</strong> ES12 3456 7890 1234 5678 9012</li>
            <li><strong>Beneficiario:</strong> Circuits Quantum, S.L.</li>
            <li><strong>Concepto:</strong> Pago Circuit ID:{{ pendingCircuit?.id || 'N/A' }} Usuario:{{ userId }}</li>
          </ul>
          <p>Tu cuenta será actualizada una vez se verifique la transferencia.</p>
        </div>

        <div class="alert alert-danger" *ngIf="isFailed">
          {{ errorMessage }}
        </div>

        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn btn-primary" [disabled]="paymentForm.invalid">Realizar Pago</button>
        </div>
      </form>
    </ng-container>

    <!-- Historial de Pagos -->
    <div *ngIf="paymentHistory.length > 0" class="mt-5">
      <hr>
      <h4>Historial de Pagos</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID de Pago</th>
            <th>Monto</th>
            <th>Moneda</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pago of paymentHistory">
            <td>{{ pago.stripePaymentId }}</td>
            <td>{{ pago.amount | currency:pago.currency:'symbol' }}</td>
            <td>{{ pago.currency.toUpperCase() }}</td>
            <td>{{ pago.paymentDate | date:'medium' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
